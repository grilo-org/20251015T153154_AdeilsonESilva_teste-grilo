
name: Grilo SC Analysis for React Native

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: {}

jobs:
  sonar-analysis:
    name: SonarCloud Analysis for React Native
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install JS dependencies (ignore peer deps)
        run: npm install --legacy-peer-deps

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
      
      - name: Attempt to build and analyze with Gradle
        id: gradle_build
        continue-on-error: true
        working-directory: ./android 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew build sonarqube --info -Dsonar.projectKey=grilo-org_20251015T153154_AdeilsonESilva_teste-grilo -Dsonar.projectName=20251015T153154_AdeilsonESilva_teste-grilo -Dsonar.organization=grilo-org -Dsonar.host.url=https://sonarcloud.io

      - name: Detect language and create Sonar config
        if: steps.gradle_build.outcome == 'failure'
        run: |
          # Detecta se é TypeScript ou JavaScript
          if [ -f "tsconfig.json" ] || grep -q '"typescript"' package.json 2>/dev/null; then
            echo "TypeScript project detected"
            INCLUSIONS="**/*.ts,**/*.tsx,**/*.js,**/*.jsx"
          else
            echo "JavaScript project detected"
            INCLUSIONS="**/*.js,**/*.jsx"
          fi
          
          # Cria arquivo de configuração do Sonar
          cat > sonar-project.properties << EOF
          sonar.projectKey=grilo-org_20251015T153154_AdeilsonESilva_teste-grilo
          sonar.projectName=20251015T153154_AdeilsonESilva_teste-grilo
          sonar.organization=grilo-org
          sonar.host.url=https://sonarcloud.io
          sonar.sources=.
          sonar.inclusions=$INCLUSIONS
          sonar.exclusions=node_modules/**,android/**,ios/**,**/*.test.*,**/*.spec.*,**/*.d.ts
          EOF
          
          echo "Sonar configuration created:"
          cat sonar-project.properties

      - name: Fallback - Analyze JS/TS only
        if: steps.gradle_build.outcome == 'failure'
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

